<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

    <title>{{#data:key/"project.title"}}</title>

    {{#Include:template/"templates.admin.main-css"}}

    {{#Include:template/"templates.admin.meta"}}
</head>
<body>

{{#Include:template/"templates.admin.sidebar"}}

{{#Include:template/"templates.admin.header"}}

<div id="editSection_{{#data:key/requestId}}" class="contentArea extraPadding editSection" reqId="{{#data:key/requestId}}">

    <div class="editData">
        {{#data:key/"modelViewHelper"
        /str/"%modelName <i class='fa fa-chevron-right' aria-hidden='true'></i>"}} ID: <span class='currId'>{{#data:key/objId}}</span>
        <i class="fa fa-chevron-right" aria-hidden="true"></i> Last Edit:
        <span class="localDateTime">{{#data:key/"dataSource.modifiedTime"}}</span></div>
    <div id="editArea" class="editArea well">

        <form id="editForm" method="post">
            <div id="inputs"></div>
            <div class="controlSection">
                {{#data:key/"allowSave"
                    /str/"<input type='submit' id='editSubmitBtn' class='btn' value='%saveChangesText'/>
                <span id='editLoading' style='display:none;'><i class='fa fa-spinner fa-pulse fa-2x fa-fw'></i>
                <span class='sr-only'>Please Wait...</span></span>"}}

                {{#data:key/"customActions.[]"
                    /str/"<div class='actionLink' data-route='%route' data-method='%method' title='%label'><i class='fa'>%icon</i></div>"}}

                {{#data:key/"allowClone"
                    /str/"<div id='cloneBtn' class='clone' ><i class='fa fa-clone' aria-hidden='true' title='Clone'></i></div>"}}

                {{#data:key/"allowDelete"
                    /str/"<div id='deleteBtn' class='delete' ><i class='fa fa-trash' aria-hidden='true' title='Delete'></i></div>
                        <div id='deleteConfirmBtn' class='delete' style='display:none;' >
                        <i class='fa fa-exclamation-triangle' aria-hidden='true'></i> Are you sure?
                    </div>"}}


            </div>
        </form>
        <div class="editData editData2">
            {{#data:key/"modelViewHelper"
            /str/"%modelName <i class='fa fa-chevron-right' aria-hidden='true'></i>"}} ID: <span class='currId'>{{#data:key/objId}}</span>
            <i class="fa fa-chevron-right" aria-hidden="true"></i> Last Edit:
            <span class="lastEditTime">
            <span class="localDateTime">{{#data:key/"dataSource.modifiedTime"}}</span></span></div>
    </div>
    <div id="warning" class="well warning" style="display:none;"></div>
    <div id="success" class="well success" style="display:none;">Save Successful!</div>
</div>

<script type="text/javascript">
    // initialize tippy
    tippy('#editSection_{{#data:key/requestId}} [title]', {
      delay: [500, 100],
      animation: 'fade',
      arrow: true,
      theme: 'rb',
    });

    function b64DecodeUnicode(str) {
        return decodeURIComponent(Array.prototype.map.call(atob(str), function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
        }).join(''))
    }

    var globalForms = globalForms || {};
    function formEdit_{{#data:key/requestId}}(dataIn){

        localizeTime();
        var self = this;
        self.reqId = '{{#data:key/requestId}}';
        self.editDiv = $('#editSection_'+self.reqId);
        self.dataset = JSON.parse("{{#data:key/view/withSlashesJSON/1}}");
        self.currData = dataIn || JSON.parse(b64DecodeUnicode("{{#data:key/obj}}"));
        self.context = "{{#data:key/context/withSlashes/1}}" || "edit";

        self.currId = "{{#data:key/objId}}";

        if (self.context === 'create')
        {
            console.log('splitscreens', splitScreens);
            console.log('splitscreens 2', self.reqId);
            for (var i=0; i<splitScreens.length; i++)
            {
                if (splitScreens[i].reqId === self.reqId)
                {
                    console.log('splitscreens set origvalue', self.dataset);
                    splitScreens[i].sessionData._id = self.currId;
                    break;
                }
            }

        }

        //self.responseCode = "{{#data:key/context/withSlashes/1}}" || "#warning";


  self.dataset.context = self.context;

  self.deleteTimer = null;
  self.showConfirm = function()
  {
      self.editDiv.find('#deleteBtn').hide();
      self.editDiv.find('#deleteConfirmBtn').delay(250).fadeIn(300);
      self.deleteTimer = setTimeout(function(){
          self.cancelDelete();
      }, 5000);
  }

  self.showInlineConfirm = function(obj)
  {
      $(obj).hide();
      var deleteKey = $(obj).attr('deleteKey');
      self.editDiv.find('div[deleteConfirmKey="'+deleteKey+'"]').delay(250).fadeIn(300);
      self.deleteTimer = setTimeout(function(){
          self.cancelInlineDelete(deleteKey);
      }, 5000);
  }

  self.cancelDelete = function()
  {
      self.deleteTimer = null;
      self.editDiv.find('#deleteConfirmBtn').fadeOut(300);
      self.editDiv.find('#deleteBtn').delay(300).fadeIn(300);
  }

  self.cancelInlineDelete = function(deleteKey)
  {
      self.deleteTimer = null;
      self.editDiv.find('div[deleteConfirmKey="'+deleteKey+'"]').fadeOut(300);
      self.editDiv.find('div[deleteKey="'+deleteKey+'"]').delay(300).fadeIn(300);
  }

  self.deleteInlineItem = function(obj)
  {
      var deleteKey = $(obj).attr('deleteConfirmKey');
      var deleteContainerKey = $(obj).attr('containerKey');

      self.editDiv.find('div[subSectionKey="'+deleteContainerKey+'"]').hide(200, function(e){
          self.editDiv.find('div[subSectionKey="'+deleteContainerKey+'"]').remove();
      });

      if (deleteContainerKey.search(/\-NEW_/) == -1)
      {
        self.editDiv.find('#editForm').append('<input type="hidden" name="'+deleteKey+'" deleter="yes" />');
      }
  }

  self.goToClone = function()
  {
        window.location = '/'+self.dataset.route+'/clone/'+self.currId;
  }


        self.editDiv.find('#cloneBtn').on('click', self.goToClone);
        self.editDiv.find('#deleteBtn').on('click', self.showConfirm);

        self.editDiv.find('#deleteConfirmBtn').attr('onclick', 'javascript:editF_'+self.reqId+'.deleteItem();');

        console.log("self.editDiv.find('#deleteBtn')", self.editDiv.find('#deleteBtn'))
        console.log("self.editDiv.find('#deleteConfirmBtn')", self.editDiv.find('#deleteConfirmBtn'))

  self.deleteItem = function()
  {

      var errTime = 1350;
      self.editDiv.find('#editSubmitBtn').hide();
      self.editDiv.find('#deleteConfirmBtn').hide();
      self.editDiv.find('#deleteBtn').hide();
      self.editDiv.find('#warning').hide();
      self.editDiv.find('#success').hide();
      $.ajax({
          url: '/'+self.dataset.route+'/delete/'+self.currId,
          type:'POST',
          data:{},
          success: function(result){

              self.editDiv.find('#success').html("This item has been deleted");
              self.editDiv.find('#success').show();
              if (window.RB && typeof window.RB.onFormSaved === 'function') {
                  if (splitScreens.length > 0)
                  {
                      closeSplitView(selectedScreen);
                  }

                        window.RB.onFormSaved(self.currId, {}, 'delete', self.currData);

              } else {
                setTimeout(function() {
                    if (splitScreens.length > 0)
                    {
                        closeSplitView(selectedScreen);
                    }
                    else
                    {
                        window.location.href = '/'+self.dataset.route;
                    }
                }, 1000);
              }

          },
          error:function(result){
              self.editDiv.find('#deleteBtn').delay(350).fadeIn(300);
              self.editDiv.find('#editSubmitBtn').delay(350).fadeIn(300);
              self.editDiv.find('#warning').hide();
              self.editDiv.find('#warning').html("Could not delete this item: ["+JSON.parse(result.responseText).message+']');
              self.editDiv.find('#warning').delay(50).fadeIn(300);
              errTime = 500;
          },
          complete:function(){
              setTimeout(function()
              {
                  self.editDiv.find('#editSubmitBtn').fadeIn(250);
              }, errTime);
          }
      });
  }

    self.formObj = buildForm(self.editDiv.find('#inputs'), self.dataset, self.currData);

   globalForms[self.reqId] = self.formObj;

    self.editDiv.find('.modelName').html(self.dataset.name);

    self.editDiv.find('.actionLink').each(function(index, link)
    {
      var submitting = false;
      var icon = $(link).children('.fa');
      var iconValue = $(icon).text();
      $(link).click(function(e)
      {
        e.preventDefault();

        if (submitting)
        {
          return;
        }
        submitting = true;
        console.log('clicked:', link);

        $(link).addClass('spin');
        $(link).addClass('disabled');
        $(icon).text('\uf110');

        self.editDiv.find('#warning').hide();
        self.editDiv.find('#success').hide();

        var start = Date.now();
        var minTime = 500;

        $.ajax({
          url: link.getAttribute('data-route'),
          type: link.getAttribute('data-method'),
          cache:false,
          success: function(result)
          {
            console.log('result:', result);
            var message = result;
            if (typeof result === 'object' && typeof result.message === 'string')
            {
              message = result.message;
            }
            else if (typeof result === 'object')
            {
              message = Object.keys(result).map(function(key)
              {
                var item = result[key];

                if (typeof item === 'object')
                {
                  item = JSON.stringify(item);
                }

                return key + ': ' + String(item);
              }).join('<br />');
            }

            console.log('message is:', message);

            var time = Date.now()
            setTimeout(function()
            {
              displaySuccess(message, 3000);
            }, Math.max(1, minTime - (time - start)));
          },
          error: function(result)
          {
            console.log('error result', arguments);
            console.log('error response text:', result.responseText);


            var message = result.statusText;
            if (result.responseJSON && result.responseJSON.message)
            {
              message = result.responseJSON.message;
            }
            else if (result.responseText)
            {
              message = result.responseText;
            }

            // make sure it feels like something actually happened
            var time = Date.now();
            setTimeout(function()
            {
              displayError('An error occurred while running ' + $(link).attr('title') + ' action [' + message + ']');
            }, Math.max(1, minTime - (time - start)));

          },
          complete: function()
          {
            var time = Date.now()
            console.log('all done');

            // make sure it feels like something actually happened
            setTimeout(function()
            {
              $(link).removeClass('spin');
              $(link).removeClass('disabled');
              $(icon).text(iconValue);
            }, Math.max(1, minTime - (time - start)));

            submitting = false;
          }
        })
      });
    });

    function displayError(text)
    {
      self.editDiv.find('#warning').hide();
      self.editDiv.find('#warning').html(text);
      self.editDiv.find('#warning').delay(50).fadeIn(300);
    }

    function displaySuccess(text, fadeoutTime)
    {
      self.editDiv.find('#success').hide();
      self.editDiv.find('#success').html(text);
      self.editDiv.find('#success').delay(50).fadeIn(300);

      if (fadeoutTime != null)
      {
        setTimeout(function()
        {
            self.editDiv.find('#success').fadeOut(300);
        }, fadeoutTime);
      }

    }

    self.editDiv.find('#editForm').submit(function(e) {
        e.preventDefault();
        self.editDiv.find('#editSubmitBtn').hide();
        self.editDiv.find('#editLoading').show(250);
        self.editDiv.find('#warning').hide();
        self.editDiv.find('#success').hide();
        var errTime = 1350;

        self.editDiv.find('#editArea').parent().animate({scrollTop:self.editDiv.find('#editArea').parent()[0].scrollHeight}, 'slow');

        //display none form values...
        var hiddens = $(e.currentTarget).find('div:hidden').find('input:enabled, select:enabled').not( 'input[type="hidden"]' );


        hiddens.attr('disabled', 'disabled');

        var checkboxes = $(e.currentTarget).find('input[type="checkbox"]');
        $.each( checkboxes, function( key, value ) {
            if (value.checked === false) {
                value.value = 'false';
            } else {
                value.value = 'true';
            }
            $(value).attr('type', 'hidden');
        });

        var editables = $(e.currentTarget).find('.editable');
        $.each( editables, function( key, value ) {
            var text = $(value)[0].innerText;//.text();
            if ($(value).attr('allowhtml'))
            {
                text = $(value)[0].innerHTML;
            }
            var key = $(value).attr('name');


            var field = $(document.createElement('input'));
            field.attr('value', text);
            field.attr('name', key);
            field.attr('id', 'temp_'+key);
            field.addClass('temp_field');
            field.attr('type', 'hidden');
            $(value).parent().append(field);
        });

        var calendarInputs = $(e.currentTarget).find('.calendarInput');
        $.each( calendarInputs, function( key, value ) {
            var inVal = $(value).val();
            var outVal = new Date(inVal);
            if ($(value).attr('stamp') == '1')
            {
                outVal = new Date(inVal).getTime();
            }


            $(value).attr('tempVal', inVal);
            $(value).val(outVal);
        });

        var insData = new FormData(e.currentTarget);
//        var insData = $(e.currentTarget).serialize();

        if (self.context === "create")
        {
            $(e.currentTarget).find(':disabled').each(function(i, element) {
                if ($(element).attr('name'))
                {
                    insData.append($(element).attr('name'), $(element).val());
                }
            });
            insData.append('_id', self.currId);
        }

        hiddens.removeAttr('disabled');

        self.editDiv.find('.temp_field').remove();
        $.each( checkboxes, function( key, value ) {
            $(value).attr('type', 'checkbox');
        });

        $.each( calendarInputs, function( key, value ) {
            $(value).val($(value).attr('tempVal'));
        });

        var useRoute = '/'+self.dataset.route+'/update/'+self.currId;

        switch (self.context)
        {
            case 'create':
            {
                useRoute = '/'+self.dataset.route+'/create';
                break;
            }
            case 'auth':
            {
                useRoute = '/'+self.dataset.route+'/login';
                break;
            }
            case 'clone':
            {
                useRoute = '/'+self.dataset.route+'/clone/'+self.currId;
                break;
            }
            default:
            {
                break;
            }
        }

        if (typeof insData.entries === 'function')
        {
          console.log('insData', insData.entries());
        }

        $.ajax({
            url: useRoute,
            dataType: "json",
            type:'POST',
            data:insData,
            cache: false,
            contentType: false,
            processData: false,
            success: function(result){
                console.log('result', result);
                console.log('resultData', result['data']);

                if (result.state == 'INFO')
                {
                    self.editDiv.find('#success').show();
                    return;
                }

                if ((typeof result['data'] != 'undefined') &&
                        (typeof result['data']['result'] != 'undefined'))
                {
                    var newData = result['data']['result'];
                    self.formObj.resetData(newData);
                }

                self.editDiv.find('.editData').find('.lastEditTime').html('<span class="localDateTime">'+new Date()+'</span>');
                localizeTime();

         /*       $.each( calendarInputs, function( key, value ) {
                    $(value).val($(value).attr('tempVal'));
                });*/

                // self.editDiv.find('#success').show();

                if (window.RB && typeof window.RB.onFormSaved === 'function')
                {
                  window.RB.onFormSaved(newData._id, newData, self.context, self.currData);
                }

                  switch (self.context)
                  {
                      case 'create':
                      {
                          if (splitScreens.length > 0)
                          {
                              displaySuccess('Save Successful!');
                              closeSplitView(selectedScreen);
                              if (window.RB && typeof window.RB.onFormSaved === 'function')
                              {
                                  setTimeout(function(){
                                      renderSplitView('/'+self.dataset.route+'/view/'+newData._id, 'true');
                                  }, 1000);
                              }
                              else
                              {
                                  renderSplitView('/'+self.dataset.route+'/view/'+newData._id);
                              }
                          }
                          else
                          {
                            displaySuccess('Save Successful!', 1000);
                              setTimeout(function() {
                                  window.location.href = '/'+self.dataset.route;
                              }, 1000);
                          }

                          break;
                      }
                      case 'auth':
                      {
                        displaySuccess('Save Successful!');
                          setTimeout(function() {
                              window.location.href = '/';
                          }, 1000);
                          break;
                      }
                      default:
                      {
                            displaySuccess('Save Successful!', 1000);
                          break;
                      }
                  }




            },
            error:function(result){
                var message = self.context === 'auth' ? 'Could not log you in ' : "Could not save changes ";
                displayError(message+" ["+JSON.parse(result.responseText).message+']');
                self.editDiv.find('#editLoading').hide(50);
                errTime = 500;
            },
            complete:function(){
                setTimeout(function()
                {
                    self.editDiv.find('#editSubmitBtn').fadeIn(250);
                    self.editDiv.find('#editLoading').hide(50);
                }, errTime);
            }
        });
    });

    }

    var editF_{{#data:key/requestId}}; // || null;

    var buildData_{{#data:key/requestId}};
    setTimeout(function(){
        editF_{{#data:key/requestId}} = new formEdit_{{#data:key/requestId}}(buildData_{{#data:key/requestId}} || null);
    }, 5);




</script>

</body>
</html>
