class RelationshipFormField extends FormField {
    constructor(parentNode, key, attr, initialValue, colW) {
        initialValue = initialValue || '';
        super(parentNode, key, attr, initialValue, colW);

        this.loaded = false;
        this.selectField = null;
        this.queryLink = attr.queryLink;
        if (attr.queryLinkMap)
        {
            console.log('ROOT FORM DATA:', this.getRootForm().objData);
            this.queryLink = replaceStr(attr.queryLink, attr.queryLinkMap, this.getForm().objData, this.getRootForm().objData);
        }


        this.load(initialValue);
    }

    renderInput(value = '') {
        if (this.attr.queryLinkMap)
        {
            const newQueryLink = replaceStr(this.attr.queryLink, this.attr.queryLinkMap, this.getForm().objData, this.getRootForm().objData);
            if (newQueryLink !== this.queryLink)
            {
                this.loaded = false;
                this.queryLink = newQueryLink;
                this.load(value);
                this.sendValueUpdate('');
            }
        }
        return this.loaded ? this.selectField.renderInput(value) : this.renderLoadingMessage();
    }

    load(value) {
        if (this.attr.queryLink)
        {
            let useQueryLink = this.queryLink;
            if (!this.isMutable())
            {
                const joinChar = useQueryLink.indexOf('?') > -1 ? '&' : '?';
                useQueryLink += `${joinChar}selected=${value}`;
            }

            console.log('USE QUERY LINK:', useQueryLink);

            const processData = (data) => {
                let values = (this.attr.values || []).concat(data.data);
                let attr = Object.assign({}, this.attr, {values});

                let TextFormField = RBForm.getFieldType('text');
                this.selectField = new TextFormField(this, this.key, attr, this.initialValue, this.colW);
                this.selectField.on('change', (value) => {
                    this.emit('change', value);
                });
                this.loaded = true;
                this.update();
            }

            if (RelationshipFormField.queryCache.has(useQueryLink)) {
                RelationshipFormField.queryCache.get(useQueryLink).onValue(processData);
            } else {
                var futureValue = new FutureValue;

                RelationshipFormField.queryCache.set(useQueryLink, futureValue);
                futureValue.onValue(processData);

                $.get(useQueryLink, (data) => {
                    // console.log('SELECT DATA!!', data);
                    try
                    {
                        // data = JSON.parse(data);
                        futureValue.setValue(data);
                    }
                    catch (e)
                    {
                        console.log('Error parsing data', e);
                        // show error
                    }
                });
            }
        } else {
            console.warn('missing query link');
        }
    }
}

RelationshipFormField.queryCache = new Map();

class FutureValue {
    constructor() {
        this.listeners = [];
        this.resolved = false;
    }

    setValue(value) {
        this.value = value;
        this.resolved = true;
        this.listeners.forEach((l) => {
            l(value);
        });

        this.listeners = [];
    }

    onValue(listener) {
        if (this.resolved) {
            listener(this.value);
        } else {
            this.listeners.push(listener);
        }
    }
}

RBForm.registerFieldType('relationship', RelationshipFormField);
